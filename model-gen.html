<!DOCTYPE html>
<html>

<head>
  <script src="https://unpkg.com/cannon@0.6.2/build/cannon.min.js"></script>
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-thumbstick-states@0.1.0/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-laser-manipulation@0.3.0/dist/laser-manipulation.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-mouse-manipulation@0.3.0/dist/mouse-manipulation.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.0/dist/aframe-extras.min.js"></script>
  <script src="https://unpkg.com/aframe-event-set-component@5.0.0/dist/aframe-event-set-component.min.js"></script>
  <script src="./lib/super-keyboard/aframe-super-keyboard.min.js"></script>
  <script src="./js/db.js"></script>
  <script src="./js/utils.js"></script>
  <script src="./js/components.js"></script>
  <link rel="stylesheet" href="./css/model-gen.css">
</head>

<body>
  <!-- The A-Frame Scene -->
  <a-scene background="color: #ECECEC" load-model-library scene-setup
            renderer="colorManagement: true;
                      physicallyCorrectLights: true;
                      shadowMap: { enabled: true, type: PCFSoftShadowMap };
                      environment: #sky;
                      environmentIntensity: 1.5;">

    <a-assets>
      <!-- "Loading circle" image -->
      <img id="update" src="./assets/images/update.png">

      <!-- Template for VR Model Library Cards -->
      <a-entity id="vr-card-template"
              class="native-card" 
              position="0 1 -2"
              scale="0.5 0.5 0.5"
              model-id="3"
              card-controls>
        
        <a-plane width="2" 
                height="2.8"
                color="azure"
                side="double"
                class="clickable card-base"
                >
        </a-plane>

        <a-image class="model-image"
                src=""
                width="1.8" height="1.8"
                position="0 -0.35 0.01"> </a-image>

        <a-text class="model-name"
                value="A cat wearing a wizard hat"
                color="#333"
                align="center"
                width="1.8"
                wrap-count="25" position="0 0.85 0.01">
        </a-text>

        <a-plane class="af-card-overlay"
                width="2" 
                height="2.8"
                position="0 0 0.05"
                color="#AAAAAA"
                opacity="0"
                visible="false"
                side="double"
                >

          <!-- Add to Scene Button -->
          <a-box width="1"
                height="0.4"
                depth="0.05"
                color="azure"
                position="0 0.7 0"
                class="af-add-to-scene"
                >
            <a-text value="Add to Scene"
                    color="#333"
                    position="0 0 0.05"
                    width="0.9"
                    align="center"
                    wrap-count="10">
            </a-text>
          </a-box>

          <!-- Download Button -->
          <a-box width="1"
                height="0.4"
                depth="0.05"
                color="azure"
                position="0 0 0"
                class="af-download"
                >
            <a-text value="Download"
                    color="#333"
                    position="0 0 0.05"
                    width="0.9"
                    align="center"
                    wrap-count="10">
            </a-text>
          </a-box>

          <!-- Delete Asset Button -->
          <a-box width="1"
                height="0.4"
                depth="0.05"
                color="salmon"
                position="0 -0.7 0"
                class="af-delete"
                >
            <a-text value="Delete Asset"
                    color="#333"
                    position="0 0 0.05"
                    width="0.9"
                    align="center"
                    wrap-count="10">
            </a-text>
          </a-box>

          <a-entity class="af-delete-query"
                    visible="false">
            <a-text value="Really Delete?"
                    color="#333"
                    position="0 0.5 0.05"
                    width="1.2"
                    align="center"
                    wrap-count="10">
            </a-text>
            <a-box width="1"
                height="0.4"
                depth="0.05"
                color="salmon"
                position="0 -0.7 0"
                class="af-confirm-delete"
                >
              <a-text value="Delete"
                      color="#333"
                      position="0 0 0.05"
                      width="0.9"
                      align="center"
                      wrap-count="10">
              </a-text>
            </a-box>
            <a-box width="1"
                  height="0.4"
                  depth="0.05"
                  color="azure"
                  position="0 0 0"
                  class="af-cancel-delete"
                  >
              <a-text value="Cancel"
                      color="#333"
                      position="0 0 0.05"
                      width="0.9"
                      align="center"
                      wrap-count="10">
              </a-text>
            </a-box>
          </a-entity>

        </a-plane>

      </a-entity>

      <!-- Template for VR Settings Panel - for adjusting model scale and removing from scene -->
      <a-entity id="vr-settings-panel-template" scale="0.6 0.6 0.6">
        <a-plane color="#CCC" width="2" height="1" opacity="0.8"></a-plane>

        <a-text class="model-name-display"
                value="Model Name" 
                width="3"
                align="center"
                position="0 0.35 0.01"></a-text>

        <a-text value="Scale:" position="-0.8 0.12 0.01" width="2"></a-text>
        
        <a-box class="clickable vr-scale-minus" color="#555" width="0.2" height="0.2" depth="0.1" position="-0.4 0.12 0.01">
          <a-text value="-" width="4" align="center" position="0 0 0.06"></a-text>
        </a-box>
        
        <a-text class="vr-scale-display" value="1.00" width="3" align="center" position="0 0.12 0.01"></a-text>
        
        <a-box class="clickable vr-scale-plus" color="#555" width="0.2" height="0.2" depth="0.1" position="0.4 0.12 0.01">
          <a-text value="+" width="4" align="center" position="0 0 0.06"></a-text>
        </a-box>

        <a-box class="clickable vr-remove-model" color="salmon" width="0.8" height="0.3" depth="0.1" position="0 -0.3 0.01">
          <a-text value="Remove Model" width="2.5" align="center" position="0 0 0.06"></a-text>
        </a-box>
      </a-entity>

      <a-asset-item id="warehouse" src="./assets/models/warehouse_building.glb"></a-asset-item>

      <a-asset-item id="sky" src="./assets/models/shanghai_bund_4k.hdr" response-type="arraybuffer"></a-asset-item>
    </a-assets>

    <!-- Lighting -->
    <a-entity light="type: ambient; intensity: 0.5"></a-entity>
    <a-entity light="type: directional;
            castShadow: true;
            intensity: 0.8;
            shadowMapHeight: 2048;
            shadowMapWidth: 2048;
            shadowBias: -0.001;
            shadowCameraLeft: -150;
            shadowCameraRight: 150;
            shadowCameraBottom: -150;
            shadowCameraTop: 150;
            shadowCameraFar: 1000;"
      position="-100 100 50">
    </a-entity>
    <a-entity light="type: directional;
            intensity: 0.6;
            castShadow: false;"
      position="100 50 -50">
    </a-entity>

    <!-- Environment -->
    <a-plane rotation="-90 0 0" scale="200 200 1" color="#777"></a-plane>
    <a-gltf-model src="#warehouse"
                  position="3 0 11.5"
                  rotation="0 90 0"
                  scale="2 2 2"
                  shadow="cast: true; receive: true;">
    </a-gltf-model>

    <!-- User Rig Component -->
    <a-entity id="rig" movement-controls="controls: gamepad, keyboard;" position="0 0 0">
      <!-- Camera -->
      <a-entity camera position="0 1.6 0" look-controls id="camera">
      </a-entity>

      <!-- Mouse Control -->
      <a-entity id="mouseCursor" cursor="rayOrigin: mouse" raycaster="objects: .clickable, .grabbable">
      </a-entity>

      <!-- VR Left and Right Controllers -->
      <a-entity id="lhand" laser-controls="hand: left"
        raycaster="objects: .clickable; far: Infinity; lineColor: blue; lineOpacity: 0.5"
        meta-touch-controls="hand: left">
      </a-entity>
      <a-entity id="rhand" laser-controls="hand: right"
        raycaster="objects: .grabbable; far: Infinity; lineColor: red; lineOpacity: 0.5" laser-manipulation
        thumbstick-states__right="controller:#rhand;
                                            tBindings:moving-in,moving-out,rotating-y-plus,rotating-y-minus;
                                            tgBindings:rotating-x-plus,rotating-x-minus,rotating-y-plus,rotating-y-minus"
        meta-touch-controls="hand: right">
      </a-entity>

    </a-entity>

    <!-- Image and Model Generation Menu -->
    <a-box id="menu-background" position="0 1.75 -5" colour="#555" scale="3.5 3.5 0.1">
      <a-box id="image-box" position="-0.3 -0.3 0.1" scale="0.25 0.25 1" color="#00AA66" class="clickable"
        generate-image>
        <a-text id="message" value="Generate Image" align="center" position="0 0 0.51" width="2" color="black"></a-text>
      </a-box>

      <a-box id="model-box" position="0.3 -0.3 0.1" scale="0.25 0.25 1" color="#CC3333" class="clickable"
        generate-model>
        <a-text value="Create Model" align="center" position="0 0 0.51" width="2" color="black"></a-text>
      </a-box>

      <a-image id="loading-image" position="0 0.25 1.01" scale="0.15 0.15 1" src="#update" visible="false"
        material="transparent: true; alphaTest: 0.8;"
        animation="property: rotation; to: 0 0 360; loop: true; dur: 3000; easing: linear;"></a-image>
      <a-image id="image" position="0 0.25 1" scale="0.33 0.33 1" src="#" visible="false"></a-image>

      <a-text id="instruction" value="Type your prompt:" align="center" position="0 0.05 1" scale="0.2 0.2 1"
        color="black"></a-text>

      <a-text id="prompt" value="Prompt" align="center" position="0 -0.05 1" scale="0.3 0.3 1" color="black"></a-text>

      <a-text id="error" visible="false" value="Error Message" align="center" position="0 -0.13 1" scale="0.2 0.2 1"
        color="red"></a-text>
    </a-box>
    <a-entity id="keyboard" super-keyboard="hand: #mouseCursor; imagePath:./lib/super-keyboard/; multipleInputs: true;"
      position="0 0.7 -4.5" rotation="-30 0 0">
    </a-entity>

    <!-- "Plinth" where models are located -->
    <a-cylinder position="3 0.1 -3"
                height="0.2"
                radius="0.5">
    </a-cylinder>

    <!-- VR model library -->
    <a-entity id="vr-library-container"
              position="-5.5 1.5 -4.9">
      <a-plane color="#CCC"
               side="double"
               width="5.5"
               height="3"
               position="0 0 0">
      </a-plane>
      <a-triangle id="vr-lib-left" 
                  color="#333" 
                  rotation="0 0 90" 
                  position="-2.5 0 0.01" 
                  scale="0.4 0.2 0.4"
                  class="clickable"
                  visible="false">
      </a-triangle>

      <a-triangle id="vr-lib-right" 
                  color="#333" 
                  rotation="0 0 -90" 
                  position="2.5 0 0.01" 
                  scale="0.4 0.2 0.4"
                  class="clickable">
      </a-triangle>
    </a-entity>
  </a-scene>

  <!-- The Desktop UI including the model library -->
  <div id="desktop-ui">
    <section class="browser-prompt-entry">

      <h2>Inputs</h2>
      <!-- Text Prompt entry -->
      <form id="desktop-prompt-form">
        <input type="text" id="desktop-prompt-input" placeholder="Text Prompt...">
        <button type="submit">Submit Text</button>
      </form>
      <!-- Image Upload -->
      <label for="image-upload-input" class="image-upload-button">Upload Image</label>
      <input type="file" id="image-upload-input" accept="image/*" hidden>
    </section>

    <section class="desktop-model-interaction">
      <h2 id="desktop-model-name">Model</h2>
      <fieldset id="custom-size-input-desktop" data-value="1" data-min="0.25" data-max="5" data-step="0.25">
        <legend>Scale:</legend>
        <div class="size-input">
          <button onclick="updateSize(-1)">-</button>
          <span class="size-value-display">1</span>
          <button onclick="updateSize(1)">+</button>
        </div>
      </fieldset>
      <div class="model-buttons">
        <button onclick="removeModel()">Remove</button>
      </div>
    </section>

    <section class="library-interface">
      <h2>Model Library</h2>
      <div class="library-scroller">


      </div>
    </section>
  </div>

  <!-- Advice message to display on non-VR devices -->
  <div id="desktop-advice">
    <p>On non-VR devices: use WASD keys to move and mouse to look & interact</p>
  </div>

  <!-- Template Card for Model Library -->
  <div class="model-card clickable" id="model-card-template">
    <h3 class="model-name"></h3>
    <img class="model-image" src="#" alt="">

    <div class="card-overlay">
      <div class="card-actions">
        <button class="card-button clickable" data-action="add">Add to Scene</button>
        <button class="card-button clickable" data-action="download">Download</button>
        <button class="card-button clickable" data-action="delete">Delete Asset</button>
      </div>
      <div class="card-confirmation">
        <p>Are you sure?</p>
        <div class="confirmation-buttons">
          <button class="card-button clickable" data-action="confirm-delete">Yes</button>
          <button class="card-button clickable" data-action="cancel-delete">No</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for labelling an uploaded image -->
  <div id="image-label-modal" class="modal-overlay">
    <div class="modal-content">
      <h2>Label Your Image</h2>
      <p>Provide a short label/description for the uploaded image.</p>
      <img id="modal-image-preview" src="#" alt="Image preview">
      <form id="image-label-form">
        <input type="text" id="image-label-input" placeholder="e.g., a cat wearing a wizard hat" required>
        <div class="modal-buttons">
          <button type="submit">Confirm</button>
          <button type="button" id="cancel-label-button">Cancel</button>
        </div>
      </form>
    </div>
  </div>

</body>

</html>